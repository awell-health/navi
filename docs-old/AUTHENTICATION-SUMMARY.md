# Navi Authentication Summary

## What You Asked For

You wanted to understand:

1. **What is a publishable key?** How does it work?
2. **What is the token in searchParams?** Where does it come from?
3. **Simple, high-level overview** without code complexity

## Simple Answer

### 1. Publishable Key (`pk_test_awell_dev_123`)

- **Like Stripe's keys**: Safe to use in frontend code
- **Identifies organization**: Maps to specific customer/organization
- **Used for API calls**: SDK sends this to navi-portal to create sessions
- **Not secret**: Can be exposed in JavaScript

### 2. Session Token (the `?token=` in URL)

- **Generated by navi-portal**: Created when SDK calls our API
- **Encrypted payload**: Contains care flow session information
- **Single-use**: Consumed when establishing embed session
- **Short-lived**: Expires in 15 minutes

## The Flow (Super Simple)

```
1. Customer initializes SDK with publishable key
   ↓
2. SDK calls navi-portal API with publishable key
   ↓
3. navi-portal validates key → creates encrypted session token
   ↓
4. SDK redirects to embed URL with token parameter
   ↓
5. Embed decrypts token → creates JWT → renders care flow
```

## What's Inside Each Token

**Publishable Key contains:**

- Organization identifier (`awell-dev`)
- Environment (`development`)
- Allowed domains for security

**Session Token contains (encrypted):**

- Care flow ID
- Patient ID
- Stakeholder ID (who is performing actions)
- Organization ID
- Authentication state (`unauthenticated`, `verified`, `authenticated`)
- Expiration time
- Navigation context (track/activity if specified)

**JWT contains:**

- API authentication claims
- Stakeholder and patient separation
- Authentication state
- Set as HttpOnly cookie
- Used for GraphQL calls

## Development Keys Available Now

You can test with these immediately:

- `pk_test_awell_dev_123` → Maps to `awell-dev` organization
- `pk_test_customer_demo_456` → Maps to `customer-demo` organization
- `pk_test_healthcare_org_789` → Maps to `healthcare-org` organization

## What Changed

**Before:** Hardcoded organization IDs, no publishable key validation
**Now:**

- Publishable keys validate against in-memory organization store
- Extract org/tenant IDs from keys
- Origin validation for security
- Proper error handling for invalid keys

## How to Test

```javascript
// In your test app
const navi = Navi("pk_test_awell_dev_123");
navi.render("#container", { careflowDefinitionId: "cf_def_123" });
```

The SDK will:

1. Send publishable key to `/api/start-careflow`
2. Get back encrypted session token
3. Redirect to `/embed/start?token=encrypted_data`
4. Embed page decrypts token and creates session

## Security Model

- **Publishable keys**: Not secret, safe in frontend
- **Session tokens**: Encrypted, short-lived, single-use
- **JWTs**: HttpOnly cookies, domain-restricted
- **Origin validation**: Keys only work from allowed domains

This gives you Stripe-like simplicity with healthcare-grade security.
